/*
Package verizon

This file was automatically generated by APIMATIC v3.0 ( https://www.apimatic.io ).
*/
package verizon

import (
    "context"
    "encoding/base64"
    "errors"
    "github.com/apimatic/go-core-runtime/https"
    "net/http"
    "time"
    "verizon/models"
)

// ThingspaceOauth1Credentials represents the credentials required for `thingspace_oauth1` authentication.
type ThingspaceOauth1Credentials struct {
    oauthClientId      string
    oauthClientSecret  string
    oauthToken         models.OauthToken
    oauthTokenProvider func (models.OauthToken, ThingspaceOauth1Manager) models.OauthToken
    oauthOnTokenUpdate func (token models.OauthToken)
    oauthClockSkew     int64
}

// NewThingspaceOauth1Credentials creates a new instance of ThingspaceOauth1Credentials with provided parameters.
func NewThingspaceOauth1Credentials(
    oauthClientId string,
    oauthClientSecret string) ThingspaceOauth1Credentials {
    return ThingspaceOauth1Credentials {
        oauthClientId: oauthClientId,
        oauthClientSecret: oauthClientSecret,
        oauthClockSkew: 0,
    }
}

// WithOauthClientId sets oauthClientId in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthClientId(oauthClientId string) ThingspaceOauth1Credentials {
    t.oauthClientId = oauthClientId
    return t
}

// WithOauthClientSecret sets oauthClientSecret in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthClientSecret(oauthClientSecret string) ThingspaceOauth1Credentials {
    t.oauthClientSecret = oauthClientSecret
    return t
}

// WithOauthToken sets oauthToken in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthToken(oauthToken models.OauthToken) ThingspaceOauth1Credentials {
    t.oauthToken = oauthToken
    return t
}

// WithOauthTokenProvider sets oauthTokenProvider in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthTokenProvider(oauthTokenProvider func (models.OauthToken, ThingspaceOauth1Manager) models.OauthToken) ThingspaceOauth1Credentials {
    t.oauthTokenProvider = oauthTokenProvider
    return t
}

// WithOauthOnTokenUpdate sets oauthOnTokenUpdate in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthOnTokenUpdate(oauthOnTokenUpdate func (token models.OauthToken)) ThingspaceOauth1Credentials {
    t.oauthOnTokenUpdate = oauthOnTokenUpdate
    return t
}

// WithOauthClockSkew sets oauthClockSkew in ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) WithOauthClockSkew(oauthClockSkew int64) ThingspaceOauth1Credentials {
    t.oauthClockSkew = oauthClockSkew
    return t
}

// OauthClientId returns the oauthClientId associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthClientId() string {
    return t.oauthClientId
}

// OauthClientSecret returns the oauthClientSecret associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthClientSecret() string {
    return t.oauthClientSecret
}

// OauthToken returns the oauthToken associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthToken() models.OauthToken {
    return t.oauthToken
}

// OauthTokenProvider returns the oauthTokenProvider associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthTokenProvider() func (models.OauthToken, ThingspaceOauth1Manager) models.OauthToken {
    return t.oauthTokenProvider
}

// OauthOnTokenUpdate returns the oauthOnTokenUpdate associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthOnTokenUpdate() func (token models.OauthToken) {
    return t.oauthOnTokenUpdate
}

// OauthClockSkew returns the oauthClockSkew associated with the ThingspaceOauth1Credentials.
func (t ThingspaceOauth1Credentials) OauthClockSkew() int64 {
    return t.oauthClockSkew
}

// isTokenValid checks if the provided OauthToken is valid.
func (t ThingspaceOauth1Credentials) isTokenValid() bool {
    return t.OauthToken().AccessToken != ""
}

// isTokenExpired checks if the provided OauthToken is expired based on the expiry timestamp.
func (t ThingspaceOauth1Credentials) isTokenExpired() bool {
    return *t.OauthToken().Expiry <= int64(time.Now().Second())
}

// ThingspaceOauth1Manager is a manager responsible for handling authorization related operations.
type ThingspaceOauth1Manager struct {
    thingspaceOauth1Credentials ThingspaceOauth1Credentials
    oauthAuthorizationApi       OauthAuthorizationApi
    oauthToken                  models.OauthToken
}

// newThingspaceOauth1Manager creates a new instance of ThingspaceOauth1Manager with the given thingspaceOauth1Credentials and OauthAuthorizationApi.
func newThingspaceOauth1Manager(
    thingspaceOauth1Credentials ThingspaceOauth1Credentials,
    oauthAuthorizationApi OauthAuthorizationApi) *ThingspaceOauth1Manager {
    thingspaceOauth1Manager := &ThingspaceOauth1Manager{
        thingspaceOauth1Credentials: thingspaceOauth1Credentials,
        oauthAuthorizationApi: oauthAuthorizationApi,
        oauthToken: thingspaceOauth1Credentials.OauthToken(),
    }
    
    return thingspaceOauth1Manager
}

// Validate function returns validation error associated with the ThingspaceOauth1Manager.
func (t *ThingspaceOauth1Manager) Validate() error {
    if t.thingspaceOauth1Credentials.OauthClientId() == "" || t.thingspaceOauth1Credentials.OauthClientSecret() == "" {
        return errors.New("thingspace_oauth1 : missing auth credentials -> OauthClientId && OauthClientSecret")
    }
    
    if !t.OauthTokenIsAuthorize() || t.OauthTokenIsExpired() {
        tokenProvider := t.thingspaceOauth1Credentials.OauthTokenProvider()
        if tokenProvider != nil {
            t.oauthToken = tokenProvider(t.thingspaceOauth1Credentials.OauthToken(), *t)
        } else if token, err := t.FetchToken(context.TODO()); err == nil {
            t.oauthToken = token
        }
    
        onTokenUpdate := t.thingspaceOauth1Credentials.OauthOnTokenUpdate()
        if onTokenUpdate != nil {
            onTokenUpdate(t.oauthToken)
        }
    }
    
    if !t.OauthTokenIsAuthorize() {
    return errors.New("thingspace_oauth1 : Client is not authorized. An OAuth token is needed to make API calls")
}
     if t.OauthTokenIsExpired() {
    return errors.New("thingspace_oauth1 : OAuth token is expired. A valid token is needed to make API calls")
}
    return nil
}

// Authenticator function returns HttpInterceptor function that provides authentication for API calls.
func (t *ThingspaceOauth1Manager) Authenticator() https.HttpInterceptor {
    return func(req *http.Request,
        next https.HttpCallExecutor,
    ) https.HttpContext {
            req.Header.Set(https.AUTHORIZATION_HEADER, "Bearer "+ t.oauthToken.AccessToken)
        return next(req)
    }
}

// FetchToken fetches the token. It makes a request to the OauthAuthorizationApi
// to obtain the token and returns the token and any error occurred during the request.
func (t *ThingspaceOauth1Manager) FetchToken(ctx context.Context) (
    models.OauthToken,
    error) {
    authorization := t.getEncodedString()
    result, err := t.oauthAuthorizationApi.RequestTokenThingspaceOauth1(ctx, authorization, nil, nil)
    if result.Data.ExpiresIn != nil && *result.Data.ExpiresIn != 0 {
        result.Data.Expiry = models.ToPointer(int64(time.Now().Second() + int(*result.Data.ExpiresIn)))
    }
    
    return result.Data, err
}

// getEncodedString encodes the provided credentials (OAuthClientId and OAuthClientSecret) to a Basic Auth string.
func (t *ThingspaceOauth1Manager) getEncodedString() string {
    return "Basic " + base64.StdEncoding.EncodeToString([]byte(t.thingspaceOauth1Credentials.OauthClientId() + ":" + t.thingspaceOauth1Credentials.OauthClientSecret()))
}

// OAuthTokenIsAuthorize checks the expiry of OAuth Token.
func (t *ThingspaceOauth1Manager) OauthTokenIsAuthorize() bool {
    return t.oauthToken.AccessToken != ""
}

// OAuthTokenIsExpired checks the expiry of OAuth Token.
func (t *ThingspaceOauth1Manager) OauthTokenIsExpired() bool {
    return *t.oauthToken.Expiry <= int64(time.Now().Second()) + t.thingspaceOauth1Credentials.OauthClockSkew()
}
